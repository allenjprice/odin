(ns apply.core
  (:require [accountant.core :as accountant]
            [antizer.reagent :as ant]
            [apply.content :as content]
            [apply.events]
            [apply.routes :as routes]
            [apply.subs]
            [day8.re-frame.http-fx]
            [goog.dom :as gdom]
            [iface.components.layout :as layout]
            [iface.modules.graphql :as graphql]
            [iface.utils.routes :as iroutes]
            [reagent.core :as r]
            [re-frame.core :as rf :refer [dispatch subscribe]]))


(defn logout []
  [:div.tr
   [:a {:href "/logout"} "Log Out"]])


(defn- svg []
  [:svg {:xmlns "http://www.w3.org/2000/svg"
         :style {:display "none"}}
   [:symbol {:id "logomark"}
    [:polyline {:points "10.6030151 5.20152355 7 7.40304709 7 3 4.60301508 4.46260388 4.60301508 8.86565097 1 11.0671745 1 14 13 6.66412742 10.6030151 5.20152355"}]
    [:polyline {:points "4.60301508 19 1 16.7480519 1 19.7480519 4.60301508 22 4.60301508 26.5038961 7 28 7 13 4.60301508 14.4961039 4.60301508 19"}]
    [:polyline {:points "9 25 12.6030151 27.2519481 9 29.5038961 11.4045226 31 15 28.7480519 18.6030151 31 21 29.5038961 9 22 9 25"}]
    [:polyline {:points "20.4045226 25.7984765 24 23.6045706 24 28 26.4045226 26.5373961 26.4045226 22.134349 30 19.9328255 30 17 18 24.3358726 20.4045226 25.7984765"}]
    [:polyline {:points "27.4045226 9 27.4045226 4.4961039 25 3 25 18 27.4045226 16.5038961 27.4045226 12 31 14.2519481 31 11.2519481 27.4045226 9"}]
    [:polyline {:points "21 6 17.3969849 3.74805195 21 1.4961039 18.6030151 0 15 2.25194805 11.4045226 0 9 1.4961039 21 9 21 6"}]]

   [:symbol {:id "paper"}
    [:path {:d "M20.1550554,2.5 L6.58918919,2.5 C5.98809913,2.5 5.5,2.98809913 5.5,3.58918919 L5.5,27.9567568 C5.5,28.5578468 5.98809913,29.0459459 6.58918919,29.0459459 L24.6,29.0459459 C25.2010901,29.0459459 25.6891892,28.5578468 25.6891892,27.9567568 L25.6891892,8.03413381 L20.1550554,2.5 Z M6.58918919,1.5 L20.3621622,1.5 C20.4947704,1.5 20.6219474,1.55267842 20.7157156,1.64644661 L26.5427426,7.47347364 C26.6365108,7.56724183 26.6891892,7.69441878 26.6891892,7.82702703 L26.6891892,27.9567568 C26.6891892,29.1101316 25.7533748,30.0459459 24.6,30.0459459 L6.58918919,30.0459459 C5.43581438,30.0459459 4.5,29.1101316 4.5,27.9567568 L4.5,3.58918919 C4.5,2.43581438 5.43581438,1.5 6.58918919,1.5 Z"}]
    [:path {:d "M19.3324324,2 C19.3324324,1.72385763 19.5562901,1.5 19.8324324,1.5 C20.1085748,1.5 20.3324324,1.72385763 20.3324324,2 L20.3324324,6.76756757 C20.3324324,7.36865763 20.8205316,7.85675676 21.4216216,7.85675676 L26.1891892,7.85675676 C26.4653316,7.85675676 26.6891892,8.08061438 26.6891892,8.35675676 C26.6891892,8.63289913 26.4653316,8.85675676 26.1891892,8.85675676 L21.4216216,8.85675676 C20.2682468,8.85675676 19.3324324,7.92094237 19.3324324,6.76756757 L19.3324324,2 Z"}]
    [:path {:d "M8.17837838,18.3918919 C7.902236,18.3918919 7.67837838,18.1680343 7.67837838,17.8918919 C7.67837838,17.6157495 7.902236,17.3918919 8.17837838,17.3918919 L23.0108108,17.3918919 C23.2869532,17.3918919 23.5108108,17.6157495 23.5108108,17.8918919 C23.5108108,18.1680343 23.2869532,18.3918919 23.0108108,18.3918919 L8.17837838,18.3918919 Z"}]
    [:path {:d "M23.0108108,20.5702703 C23.2869532,20.5702703 23.5108108,20.7941279 23.5108108,21.0702703 C23.5108108,21.3464126 23.2869532,21.5702703 23.0108108,21.5702703 L8.17837838,21.5702703 C7.902236,21.5702703 7.67837838,21.3464126 7.67837838,21.0702703 C7.67837838,20.7941279 7.902236,20.5702703 8.17837838,20.5702703 L23.0108108,20.5702703 Z"}]
    [:path {:d "M8.17837838,24.7486486 C7.902236,24.7486486 7.67837838,24.524791 7.67837838,24.2486486 C7.67837838,23.9725063 7.902236,23.7486486 8.17837838,23.7486486 L19.8324324,23.7486486 C20.1085748,23.7486486 20.3324324,23.9725063 20.3324324,24.2486486 C20.3324324,24.524791 20.1085748,24.7486486 19.8324324,24.7486486 L8.17837838,24.7486486 Z"}]
    [:path {:d "M8.67837838,14.714573 C8.67837838,14.9907153 8.45452075,15.214573 8.17837838,15.214573 C7.902236,15.214573 7.67837838,14.9907153 7.67837838,14.714573 C7.67837838,12.6830763 9.32544971,11.0361946 11.3567568,11.0361946 C13.3880638,11.0361946 15.0351351,12.6830763 15.0351351,14.714573 C15.0351351,14.9907153 14.8112775,15.214573 14.5351351,15.214573 C14.2589928,15.214573 14.0351351,14.9907153 14.0351351,14.714573 C14.0351351,13.2353868 12.8358048,12.0361946 11.3567568,12.0361946 C9.87770869,12.0361946 8.67837838,13.2353868 8.67837838,14.714573 Z"}]
    [:path {:d "M12.9756757,9.41727568 C12.9756757,8.52291763 12.2509897,7.79835676 11.3567568,7.79835676 C10.4625238,7.79835676 9.73783784,8.52291763 9.73783784,9.41727568 C9.73783784,10.3109788 10.4629284,11.0361946 11.3567568,11.0361946 C12.2505851,11.0361946 12.9756757,10.3109788 12.9756757,9.41727568 Z M13.9756757,9.41727568 C13.9756757,10.8632249 12.8029085,12.0361946 11.3567568,12.0361946 C9.910605,12.0361946 8.73783784,10.8632249 8.73783784,9.41727568 C8.73783784,7.97059422 9.91027776,6.79835676 11.3567568,6.79835676 C12.8032358,6.79835676 13.9756757,7.97059422 13.9756757,9.41727568 Z"}]]

   [:symbol {:id "truck"}
    [:path {:d "M21.5,24 C21.5,22.0673576 23.0673576,20.5 25,20.5 C26.9326424,20.5 28.5,22.0673576 28.5,24 C28.5,25.9326424 26.9326424,27.5 25,27.5 C23.0673576,27.5 21.5,25.9326424 21.5,24 Z M22.5,24 C22.5,25.3803576 23.6196424,26.5 25,26.5 C26.3803576,26.5 27.5,25.3803576 27.5,24 C27.5,22.6196424 26.3803576,21.5 25,21.5 C23.6196424,21.5 22.5,22.6196424 22.5,24 Z"}]
    [:path {:d "M3.5,24 C3.5,22.0673576 5.06735763,20.5 7,20.5 C8.93264237,20.5 10.5,22.0673576 10.5,24 C10.5,25.9326424 8.93264237,27.5 7,27.5 C5.06735763,27.5 3.5,25.9326424 3.5,24 Z M4.5,24 C4.5,25.3803576 5.61964237,26.5 7,26.5 C8.38035763,26.5 9.5,25.3803576 9.5,24 C9.5,22.6196424 8.38035763,21.5 7,21.5 C5.61964237,21.5 4.5,22.6196424 4.5,24 Z"}]
    [:path {:d "M10.4891356,24.5 C10.2129932,24.5 9.98913557,24.2761424 9.98913557,24 C9.98913557,23.7238576 10.2129932,23.5 10.4891356,23.5 L22,23.5 C22.2761424,23.5 22.5,23.7238576 22.5,24 C22.5,24.2761424 22.2761424,24.5 22,24.5 L10.4891356,24.5 Z"}]
    [:path {:d "M23.5,24 C23.5,23.1718576 24.1718576,22.5 25,22.5 C25.8281424,22.5 26.5,23.1718576 26.5,24 C26.5,24.8281424 25.8281424,25.5 25,25.5 C24.1718576,25.5 23.5,24.8281424 23.5,24 Z M24.5,24 C24.5,24.2758576 24.7241424,24.5 25,24.5 C25.2758576,24.5 25.5,24.2758576 25.5,24 C25.5,23.7241424 25.2758576,23.5 25,23.5 C24.7241424,23.5 24.5,23.7241424 24.5,24 Z"}]
    [:path {:d "M5.5,24 C5.5,23.1718576 6.17185763,22.5 7,22.5 C7.82814237,22.5 8.5,23.1718576 8.5,24 C8.5,24.8281424 7.82814237,25.5 7,25.5 C6.17185763,25.5 5.5,24.8281424 5.5,24 Z M6.5,24 C6.5,24.2758576 6.72414237,24.5 7,24.5 C7.27585763,24.5 7.5,24.2758576 7.5,24 C7.5,23.7241424 7.27585763,23.5 7,23.5 C6.72414237,23.5 6.5,23.7241424 6.5,24 Z"}]
    [:path {:d "M3.5,23.5 L4,23.5 C4.27614237,23.5 4.5,23.7238576 4.5,24 C4.5,24.2761424 4.27614237,24.5 4,24.5 L3,24.5 C2.72385763,24.5 2.5,24.2761424 2.5,24 L2.5,6 C2.5,5.72385763 2.72385763,5.5 3,5.5 L20,5.5 C20.2761424,5.5 20.5,5.72385763 20.5,6 L20.5,24 C20.5,24.2761424 20.2761424,24.5 20,24.5 C19.7238576,24.5 19.5,24.2761424 19.5,24 L19.5,6.5 L3.5,6.5 L3.5,23.5 Z"}]
    [:path {:d "M28,24.5 C27.7238576,24.5 27.5,24.2761424 27.5,24 C27.5,23.7238576 27.7238576,23.5 28,23.5 L29,23.5 C29.2758576,23.5 29.5,23.2758576 29.5,23 L29.5,16.664 C29.5,16.3159444 29.4091734,15.9739606 29.2363762,15.6715655 L25.8538784,9.75206947 C25.7648539,9.59627657 25.598979,9.5 25.4195,9.5 L20,9.5 C19.7238576,9.5 19.5,9.27614237 19.5,9 C19.5,8.72385763 19.7238576,8.5 20,8.5 L25.4195,8.5 C25.9578627,8.5 26.4550675,8.78858596 26.7221238,9.25593448 L30.1046216,15.1754305 C30.3637544,15.6289129 30.5,16.14191 30.5,16.664 L30.5,23 C30.5,23.8281424 29.8281424,24.5 29,24.5 L28,24.5 Z"}]
    [:path {:d "M27.9472136,15.7763932 C28.1134389,16.1088437 27.871691,16.5 27.5,16.5 L22,16.5 C21.7238576,16.5 21.5,16.2761424 21.5,16 L21.5,11 C21.5,10.7238576 21.7238576,10.5 22,10.5 L25,10.5 C25.189386,10.5 25.3625176,10.6070012 25.4472136,10.7763932 L27.9472136,15.7763932 Z M24.690983,11.5 L22.5,11.5 L22.5,15.5 L26.690983,15.5 L24.690983,11.5 Z"}]]

   [:symbol {:id "credit-card"}
    [:path {:d "M25.5,11.5 C26.6046424,11.5 27.5,12.3953576 27.5,13.5 L27.5,27.5 C27.5,28.6046424 26.6046424,29.5 25.5,29.5 L4.5,29.5 C3.39535763,29.5 2.5,28.6046424 2.5,27.5 L2.5,13.5 C2.5,12.3953576 3.39535763,11.5 4.5,11.5 L25.5,11.5 Z M25.5,12.5 L4.5,12.5 C3.94764237,12.5 3.5,12.9476424 3.5,13.5 L3.5,27.5 C3.5,28.0523576 3.94764237,28.5 4.5,28.5 L25.5,28.5 C26.0523576,28.5 26.5,28.0523576 26.5,27.5 L26.5,13.5 C26.5,12.9476424 26.0523576,12.5 25.5,12.5 Z"}]
    [:path {:d "M11,14.5 C11.7761424,14.5 12.5,15.2238576 12.5,16 L12.5,19 C12.5,19.7761424 11.7761424,20.5 11,20.5 L7,20.5 C6.22385763,20.5 5.5,19.7761424 5.5,19 L5.5,16 C5.5,15.2238576 6.22385763,14.5 7,14.5 L11,14.5 Z M11,15.5 L7,15.5 C6.77614237,15.5 6.5,15.7761424 6.5,16 L6.5,19 C6.5,19.2238576 6.77614237,19.5 7,19.5 L11,19.5 C11.2238576,19.5 11.5,19.2238576 11.5,19 L11.5,16 C11.5,15.7761424 11.2238576,15.5 11,15.5 Z"}]
    [:path {:d "M6,23.5 C5.72385763,23.5 5.5,23.2761424 5.5,23 C5.5,22.7238576 5.72385763,22.5 6,22.5 L9,22.5 C9.27614237,22.5 9.5,22.7238576 9.5,23 C9.5,23.2761424 9.27614237,23.5 9,23.5 L6,23.5 Z"}]
    [:path {:d "M11,23.5 C10.7238576,23.5 10.5,23.2761424 10.5,23 C10.5,22.7238576 10.7238576,22.5 11,22.5 L14,22.5 C14.2761424,22.5 14.5,22.7238576 14.5,23 C14.5,23.2761424 14.2761424,23.5 14,23.5 L11,23.5 Z"}]
    [:path {:d "M16,23.5 C15.7238576,23.5 15.5,23.2761424 15.5,23 C15.5,22.7238576 15.7238576,22.5 16,22.5 L19,22.5 C19.2761424,22.5 19.5,22.7238576 19.5,23 C19.5,23.2761424 19.2761424,23.5 19,23.5 L16,23.5 Z"}]
    [:path {:d "M21,23.5 C20.7238576,23.5 20.5,23.2761424 20.5,23 C20.5,22.7238576 20.7238576,22.5 21,22.5 L24,22.5 C24.2761424,22.5 24.5,22.7238576 24.5,23 C24.5,23.2761424 24.2761424,23.5 24,23.5 L21,23.5 Z"}]
    [:path {:d "M6,26.5 C5.72385763,26.5 5.5,26.2761424 5.5,26 C5.5,25.7238576 5.72385763,25.5 6,25.5 L14,25.5 C14.2761424,25.5 14.5,25.7238576 14.5,26 C14.5,26.2761424 14.2761424,26.5 14,26.5 L6,26.5 Z"}]
    [:path {:d "M8.5,15 C8.5,14.7238576 8.72385763,14.5 9,14.5 C9.27614237,14.5 9.5,14.7238576 9.5,15 L9.5,20 C9.5,20.2761424 9.27614237,20.5 9,20.5 C8.72385763,20.5 8.5,20.2761424 8.5,20 L8.5,15 Z"}]
    [:path {:d "M29.1025534,15.3008034 C28.9072912,15.4960655 28.5907088,15.4960655 28.3954466,15.3008034 C28.2001845,15.1055412 28.2001845,14.7889588 28.3954466,14.5936966 L29.2184466,13.7706966 C29.5936586,13.3954846 29.5936586,12.7881866 29.2184374,12.4132942 L19.5869466,2.78130339 C19.2117346,2.40609138 18.6044366,2.40609138 18.2225287,2.78819116 L10.3465287,10.3601912 C10.1474626,10.5515737 9.83094139,10.5453449 9.63955884,10.3462787 C9.4481763,10.1472126 9.4544051,9.83069139 9.65347125,9.63930884 L17.5222916,2.07435164 C18.2875634,1.30840862 19.5282654,1.30840862 20.2940626,2.07420579 L29.9253984,11.7060416 C30.6913414,12.4713134 30.6913414,13.7120154 29.9255534,14.4778034 L29.1025534,15.3008034 Z"}]
    [:path {:d "M20.7841252,3.25789741 C20.9830872,3.0664066 21.2996118,3.07246321 21.4911026,3.27142522 C21.6825934,3.47038723 21.6765368,3.78691178 21.4775748,3.97840259 L14.8465748,10.3604026 C14.6476128,10.5518934 14.3310882,10.5458368 14.1395974,10.3468748 C13.9481066,10.1479128 13.9541632,9.83138822 14.1531252,9.63989741 L20.7841252,3.25789741 Z"}]
    [:path {:d "M23.7900644,6.25227407 C23.9921321,6.0640634 24.3085153,6.07529674 24.4967259,6.27736443 C24.6849366,6.47943213 24.6737033,6.79581526 24.4716356,6.98402593 L20.8406356,10.3660259 C20.6385679,10.5542366 20.3221847,10.5430033 20.1339741,10.3409356 C19.9457634,10.1388679 19.9569967,9.82248474 20.1590644,9.63427407 L23.7900644,6.25227407 Z"}]]
   ])


(defn- welcome-1 [{name :name} toggle]
  [:section.main.main-no-nav.center
   [:div.w-60-l.w-100.center
    [:h1.tc "Welcome to starcity,"]
    [:h2.tc name]]
   [:div.page-content.w-90-l.w-100.center.tc
    [:p.tc "You've taken your first step to joining a Starcity community."]
    [:p.tc "We're looking forward to getting to know you."]
    [:br]
    [:p.tc "I'm here to help you with your application. If you have a"]
    [:p.tc "question, click on the `Q&A` icon to send me a message."]
    [:br]
    [:div
     [ant/avatar
      {:icon "user"}]]
    [:h3 "- Matt (the chatlio king)"]
    [:br]
    [:br]
    [:button.button.mt5
     {:on-click #(swap! toggle not)}
     "Let's go!"]]])


(defn- welcome-2 []
  [:section.main.main-no-nav.center
   [:div.w-60-l.w-100.center
    [:h1.tc "Here's what you'll need"]]
   [:div.page-content.w-90-l.w-100.center.tc
    [:div.cf.mt5
     [:div.w-third-l.w-100.fl.ph4
      [:svg
       [:use {:xlinkHref "#truck"}]]
      [:h3 "Logistics"]
      [:p "We’ll need to know stuff like which communities you'd like to join, you’re preferred move-in date, and how long you'll be staying with us."]]
     [:div.w-third-l.w-100.fl.ph4
      [:svg
       [:use {:xlinkHref "#paper"}]]
      [:h3 "Personal Information"]
      [:p "Provide us with some personal information so that we can perform a background check and verify your income."]]
     [:div.w-third-l.w-100.fl.ph4
      [:svg
       [:use {:xlinkHref "#credit-card"}]]
      [:h3 "Application Fee"]
      [:p "It’ll cost $25 for each application – that helps cover the cost of the background check."]]]
    [:button.button.mt5
     {:on-click #(.log js/console "click!")}
     "Got it"]]])


(defmethod content/view :welcome [{:keys [requester] :as route}]
  (let [toggle (r/atom false)]
    (fn []
      [:div
       [svg]
       [:div.w-60-l.w-100.center
        [:svg.logo
         [:use {:xlinkHref "#logomark"}]]]
       (if @toggle
         [welcome-2]
         [welcome-1 requester toggle])
       [:div.bg-top]])))


(defn layout []
  (let [route (subscribe [:route/current])]
    [layout/layout
     [logout]
     [layout/content
      [content/view @route]]]))


;; ==============================================================================
;; app entry ====================================================================
;; ==============================================================================


(defn render []
  (r/render
   [ant/locale-provider {:locale (ant/locales "en_US")}
    [layout]]
   (gdom/getElement "apply")))


(defn reload! []
  (render)
  (accountant/dispatch-current!))


(defn ^:export run []
  (let [account (js->clj (aget js/window "account") :keywordize-keys true)]
    (graphql/configure
     "/api/graphql"
     {:on-unauthenticated (fn [_]
                            {:route "/logout"})
      :on-error-fx        (fn [[k _]]
                            {:dispatch [:ui/loading k false]})})


    (rf/dispatch-sync [:app/init account])
    (iroutes/hook-browser-navigation! routes/app-routes)
    (render)))
